# DECO组网功能规范

## 1. 基本功能要求
### 1.1. 概述
DECO机型的组网模块负责将多个DECO通过特地的方式连结成一个网络，保证网络正常工作，自动处理网络异常。

### 1.2. 基本准则
- 组网模块需要通过多种方式将多个DECO连接到一起，确保不存在孤立的DECO.
- 组网模块需要将DECO连接成为树形网络，保证网络有且只有一个出口，配置apsd或链路备份等其他模块保证网络不回环，网络中数据通信正常。
- 组网模块需要应对拓扑变化，针对DECO加入、离开网络，DECO间物理连接方式发生变化的各种场景调整网络。


### 1.3. 组网策略与连接对象选择
组网模块目前支持WIFI、PLC、ETHERNET多种连接方式。只要某个DECO被标记为同一个网络，不管拓扑只支持某种特定连接方式还是多种连接方式混合连接，组网模块均需按照一定的标准选择连接对象，连接成为符合基本准则的网络。

#### 1.3.1. WIFI组网
##### 1.3.1.1. 连接对象选择
WIFI组网选择连接对象需兼容性能和实际环境稳定性需求，并给予AP一定的权重，目前基本策略如下。
```
		i. 上一级的信号高于一定数值，选上一级。
		ii. 上一级的信号弱到一定程度，而下一级的信号高于一定数值，选下一级。
		iii. 对AP->RE2 和AP->RE1->RE2两条通道的整体估算速率进行比较，决定RE2连接到AP还是RE1。
		AP->RE1->RE2通道的估算方法为，AP->RE1：r1, RE1->RE2: r2, 整条通道的速率为factor*（r1*r2）/(r1+r2)
```
- 首先在屏蔽环境下测定AP与RE之间backhaul的性能曲线，分别取峰值性能的0.7＊1／2, 0.7 * 1/4处的信号强度为上临界值与下临界值初始值。权重因子factor初始值设定为0.7.
- 在开放环境下选取一系列的RE放置点进行性能测试，根据测试结果对临界值和权重因子进行微调，标准为路径短者性能不低于路径长者性能的70%.
- 在开放环境下进行稳定性测试，若RE连接频繁断线，应考虑调整临界值，在稳定性和性能存在冲突时，优先考虑稳定性。

##### 1.3.1.2. 多频段连接
WIFI组网支持多频段连接，目前多个WIFI频段连接到一个前端上，在选择连接对象时：
- 鉴于各频段信号强度存在差异，折算路径速率较难，目前由各个频段各自选择最佳连接对象。
- 选择完毕若各频段未选择同一个前端，若存在两个5G频段，需要以两条5G路径的估算速率进行比较。
- 若5G的信号强度高于下临界值，以5G为准。否则需要对5G路径和2G路径的估算速率进行比较。

##### 1.3.1.3. 多级拓扑变化
- WIFI组网需支持多级拓扑，将网络出口定义为第1级，测试验证应满足五级拓扑正常工作。
- 应验证拓扑级数变化时是否能正常切换，分别验证拓扑头部节点，叶子节点和中间节点离开时能否回复为一个不存在孤立节点的树形网络。

#### 1.3.2. PLC和ETHERNET组网
PLC和ETHERNET组网连接实际由用户控制，链路的端点实际上是对等的，但为确保网络有且只有一个出口，需要在所有可见的Ethernet或PLC中选择层级最高（离Internet最近）的一个作为前端。

如果最高的层级存在多个PLC或Ethernet，需要在该层级中选择MAC大的作为网络的根节点，最终PLC或Ethernet网络形成一个星形网络。该星形网络有且只有一个根节点，其余PLC或Ethernet为同一级别的叶子节点。

#### 1.3.3. 混合组网
##### 1.3.3.1 连接对象选择
混合组网实现的一个关键因素在于不同的连接方式是否可以选择不同的连接对象，而这取决与apsd等数据流控制模块。
若WIFI、PLC、Ethernet可以选择不同连接对象，组网模块无需做特殊处理。
否则组网模块需要确保不通通路均选择同一连接对象，下文仅针对此种场景进行论述。

- 由于Ethernet连接为公共通路，仅由用户控制，DECO无法自行断开Ethernet连接，存在Ethernet backhaul时，断开PLC和WIFI连接。
- PLC可视为DECO间的私有通路，可通过将对应接口从bridge中移除来断开PLC通路。
- PLC通路不管断开还是连接实际上都是配对成功的，开机一小段时间即可估算出PLC协商速率，通过比较PLC协商速率和WIFI通路估算速率选择较优链路。具体策略如下：
```
    i. WIFI前端的层级小于等于PLC，如果5G信号或者2.4G信号大于临界值选择WIFI.
		ii. 根据PLC到达网络顶点的路径长度，估算PLC PATH RATE = PLC RATE * 〖0.7〗^n.如果PLC PATH RATE < 20Mbps，选择WIFI。
    iii. 两者在同一个网络中，WIFI选择PATH RATE较大的频段与PLC PATH RATE比较，选择PATH RATE较大的。
```
> 临界值的选择与PLC通路的性能峰值相关，根据WIFI性能曲线取PLC通路的性能峰值对应的5G和2.4G信号强度为临界值。

##### 1.3.3.2 连接方式切换
组网模块应验证多种连接方式进行切换时是否正常工作。
按照初始状态为某种连接方式，星型、串行拓扑，子连接替换顺序的排列组合依次验证组网模块对连接方式的切换是否处理正常。

## 2. 稳定性要求
### 2.1. 连接稳定性
- 组网模块应尽量保持拓扑结构保持稳定，在当前链路满足使用需求的前提下，不轻易断开连接。在背景环境信道使用率低于30%的场景下，应经过24小时稳定性测试不断开连接。
- 组网模块在受到干扰断开连接之后，应尽量重新连接上一次的连接对象避免过多的扫描。

### 2.2. 重启稳定性
组网模块需要对模块运行稳定性进行验证，在至少三个DECO的拓扑下分别对AP和RE重启500次，重启完毕均应正常组网。

## 3. 性能要求
### 3.1. 扫描时间
- WIFI多频段连接时需多频段同时扫描，一次扫描时间控制在6秒之内。
- 在已知信道需要快速连接的场景下，一次扫描时间控制在1秒之内。
- 存在连接对象时最多扫描两次。

### 3.2. 连接时间
- DECO进行模式切换时时间应控制在30s内。
- DECO切换连接对象时时间应控制在20s内。
